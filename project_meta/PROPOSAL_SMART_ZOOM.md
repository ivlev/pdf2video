# Proposal: Smart Zoom & Scenario Config

**Цель:** Реализовать «умную» навигацию камеры по слайду, автоматически фокусируясь на заголовках, тексте и ключевых объектах.
**Связанные задачи Roadmap:**
- [x] Конфигурационный файл (YAML/JSON)
- [x] OCR/Text Focus (Smart Zoom)

---

## 1. Архитектура: "Analyze -> Plan -> Render"

Предлагается разделить процесс на три этапа:

1.  **Analyze (Анализ):**
    -   Вход: Изображение или страница PDF.
    -   Процесс: Поиск "Region of Interest" (ROI) — заголовки, текстовые блоки, контрастные объекты.
    -   Инструменты:
        -   *Вариант А (Простой):* Анализ плотности пикселей и краев (Edge Detection) на чистом Go (без CGO).
        -   *Вариант Б (Продвинутый):* Использование `gosseract` (Tesseract OCR) для точного поиска текста.
        -   *Вариант В (AI):* Использование легковесных моделей (ONNX) для детекции объектов.
    -   Выход: Список прямоугольников `[]Rect` (x, y, w, h, type).

2.  **Plan (Планирование):**
    -   Вход: Список ROI.
    -   Процесс: Генерация "Пути камеры" (Camera Path).
        -   Сортировка блоков (обычно сверху-вниз, слева-направо).
        -   Генерация ключевых кадров (Keyframes): центр блока + масштаб.
        -   Расчет переходов: плавное перемещение от блока к блоку.
    -   Выход: **Сценарий анимации** (сохраняется в YAML/JSON).

3.  **Render (Рендеринг):**
    -   Вход: YAML/JSON сценарий (автоматически созданный или отредактированный вручную).
    -   Процесс: `engine` читает сценарий и применяет трансформации (Zoom/Pan) для каждого кадра.

---

## 2. Формат Конфигурации (Scenario Schema)

Мы будем использовать **YAML** как более читаемый для человека формат.

### Пример `scenario.yaml`:
```yaml
version: 1.0
slides:
  - id: 1
    input: "page_001.png"
    duration: 10s
    # Автоматически сгенерированные ключевые точки
    keyframes:
      - time: 0s
        focus: "region_1" # Заголовок
        rect: {x: 50, y: 50, w: 900, h: 200}
        zoom: 1.2
      - time: 3s
        focus: "region_2" # Первый абзац
        rect: {x: 50, y: 300, w: 400, h: 600}
        zoom: 1.5
      - time: 8s
        focus: "full_view" # Общий вид в конце
        rect: {x: 0, y: 0, w: 1280, h: 720}
        zoom: 1.0
```

---

## 3. Техническая Реализация

### Этап 1: Модуль `internal/analyzer`
Создадим интерфейс `SaliencyDetector`:

```go
type Block struct {
    Rect      image.Rectangle
    Type      string // "text", "header", "image"
    Confidence float64
}

type Detector interface {
    Detect(img image.Image) ([]Block, error)
}
```

**Алгоритм "Contrast Scanner" (MVP):**
Для начала, без тяжелых зависимостей (Tesseract), реализуем алгоритм на основе *Sobel Edge Detection* + *Morphological Dilation*:
1.  Перевести изображение в Grayscale.
2.  Найти границы (Sobel).
3.  "Размыть" границы, чтобы объединить буквы в слова, а слова в блоки.
4.  Найти контуры получившихся "пятен".
5.  Отфильтровать слишком мелкие "пятна".
6.  Это и есть наши блоки внимания.

### Этап 2: Генератор Сценария (`internal/director`)
Модуль, который берет `[]Block` и превращает их в таймлайн:
- **Duration Strategy**: Рассчитать время показа блока в зависимости от его размера (площади) или количества (если это OCR).
- **Fit Strategy**:
    -   *Landscape Block*: Зуммировать так, чтобы ширина блока занимала 80-90% ширины экрана.
    -   *Portrait Block*: Зуммировать по высоте.

### Этап 3: Интеграция в `engine`
- Добавить флаг `-smart-zoom`.
- Если включен:
    1.  Запуск `analyzer` для каждого слайда.
    2.  Генерация `scenario.yaml` (в памяти или на диске).
    3.  Рендеринг не по простому `-zoom-mode`, а интерполяция между координатами из сценария.

---

## 4. Результат реализации (v0.7)

Предложение было успешно реализовано и интегрировано в основную ветку:

1.  **internal/analyzer**: Реализован `ContrastDetector` на основе фильтра Собеля и морфологического расширения (Pure Go).
2.  **internal/director**: Создан оркестратор, который планирует путь камеры и генерирует YAML-сценарии.
3.  **internal/effects**: Добавлен `ScenarioEffect`, реализующий piecewise-интерполяцию между ключевыми кадрами.
4.  **engine**: Добавлена поддержка флагов `-generate-scenario` и `-scenario`.
5.  **Audio Sync**: Реализовано автоматическое масштабирование сценариев под длительность аудио.

**Статус:** ВЫПОЛНЕНО (14.02.2026)

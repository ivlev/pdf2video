# Функциональная спецификация pdf2video

**Версия:** 0.6 (Smart Zoom)
**Дата:** 13.02.2026

## 1. Обзор продукта
`pdf2video` — это высокопроизводительная утилита командной строки (CLI) для автоматического создания динамичных видео-презентаций из статических PDF-файлов или наборов изображений. Программа превращает статичные слайды в кинематографичный видеоряд с наложением эффектов («Zoom Drift», переходы), синхронизацией с аудио и аппаратным ускорением.

## 2. Основные возможности

### 2.1. Входные данные
- **PDF Документы:** Рендеринг страниц в высоком разрешении (настраиваемый DPI).
- **Изображения:** Папки с файлами `.jpg`, `.jpeg`, `.png`. Поддерживается сортировка и фильтрация.
- **Аудио:** Автоматический подбор саундтрека из папки `input/audio` или указание конкретного файла.

### 2.2. Генерация видео
- **Пресеты:** Готовые форматы для соцсетей:
    - `16:9` (YouTube)
    - `9:16` (TikTok, Reels, Shorts)
    - `4:5` (Instagram Feed)
- **Zoom Drift:** Интеллектуальный эффект «дыхания» камеры (плавное приближение и возврат).
- **Переходы:** Поддержка `xfade` (fade, wipe, slide, pixelize и др.).
- **Синхронизация:** Длительность видео автоматически подстраивается под длину аудио-трека (если включено).
- **Рандомизация:** Длительность каждого слайда варьируется на ±15% от средней для создания живого ритма.

## 3. Архитектура и Оптимизации

### 3.1. Аппаратное ускорение
Приложение автоматически выбирает лучший доступный энкодер:
- **macOS:** `h264_videotoolbox` (Apple Silicon / Intel). Использует битрейт-контроль (`-b:v`).
- **NVIDIA:** `h264_nvenc` (NVENC).
- **CPU:** `libx264` (Fallback).

### 3.2. Pipelining (Потоковая обработка)
Архитектура разделена на два независимых пула воркеров:
1.  **Render Pool (CPU):** Рендерит страницы PDF в изображения. Масштабируется на все ядра.
2.  **Encode Pool (GPU):** Кодирует видео-сегменты. Ограничен 4 потоками для защиты GPU-памяти.
Данные передаются через буферизированные каналы, обеспечивая 100% загрузку ресурсов без простоев.

### 3.3. Memory Pipes (Zero-Disk I/O)
Изображения передаются из Render Pool в FFmpeg напрямую через оперативную память (stdin pipe) в формате `rawvideo`. Промежуточные PNG файлы не создаются, что значительно снижает износ SSD и ускоряет работу.

### 3.4. Smart Zoom (Умная камера)
Автоматический анализ изображений и генерация сценариев движения камеры:
- **Analyze:** Детекция регионов интереса (заголовки, текст, объекты) через алгоритм Sobel + морфология.
- **Plan:** Генерация YAML сценария с ключевыми кадрами, зумом и таймингом.
- **Render:** Применение сценария для создания динамичного видео (в разработке).

## 4. Справочник конфигурации (Флаги)

### Основные
| Флаг | Описание | По умолчанию |
|------|----------|--------------|
| `-input` | Путь к PDF или папке с изображениями | Свежий файл в `input/pdf/` |
| `-output` | Путь к выходному файлу | Авто-генерация в `output/` |
| `-preset` | Пресет формата (`16:9`, `9:16`, `4:5`) | - |

### Видео и Аудио
| Флаг | Описание | По умолчанию |
|------|----------|--------------|
| `-width`, `-height` | Явное указание разрешения | 1280x720 |
| `-fps` | Частота кадров | 30 |
| `-duration` | Общая длительность видео (сек) | 0 (авто по аудио) |
| `-page-duration` | Средняя длительность слайда (сек) | 0.3 |
| `-audio` | Путь к аудио-файлу | Свежий файл в `input/audio/` |
| `-audio-sync` | Синхронизировать видео под длину аудио | `true` |

### Эффекты
| Флаг | Описание | По умолчанию |
|------|----------|--------------|
| `-zoom-mode` | Тип зума (`center`, `random` и др.) | `center` |
| `-zoom-speed` | Скорость зума | `0.001` |
| `-transition` | Тип перехода (`fade`, `wipeleft`...) | `fade` |
| `-fade` | Длительность перехода (сек) | `0.5` |

### Качество и Производительность
| Флаг | Описание | По умолчанию |
|------|----------|--------------|
| `-dpi` | Качество рендеринга PDF | 300 |
| `-quality` | Качество (CRF для x264, Битрейт для GPU) | `авто` (x264: 23, VT: 75) |
| `-stats` | Вывод метрик производительности | `false` |
| `-workers` | Количество потоков рендеринга | Все ядра CPU |

### Smart Zoom (Анализ и Сценарии)
| Флаг | Описание | По умолчанию |
|------|----------|--------------|
| `-analyze-mode` | Режим анализа (`contrast`, `ocr`, `ai`) | `contrast` |
| `-min-block-area` | Минимальная площадь блока (пиксели²) | 500 |
| `-edge-threshold` | Порог чувствительности границ | 30.0 |
| `-generate-scenario` | Генерировать YAML сценарий | `false` |
| `-scenario-output` | Путь для сохранения сценария | `internal/scenarios/scenario_YYYY-MM-DD_HH-MM-SS.yaml` |
| `-scenario` | Путь к сценарию для рендеринга | Самый свежий из `internal/scenarios/` |

## 5. Сценарии использования

### Быстрый тест
```bash
./pdf2video -stats
```
Берет первый попавшийся PDF и аудио, создает видео, выводит статистику.

### Создание Shorts для TikTok
```bash
./pdf2video -input presentation.pdf -preset 9:16 -duration 60 -zoom-mode random
```
Создает вертикальное видео ровно на 60 секунд со случайными движениями камеры.

### Максимальное качество (4K)
```bash
./pdf2video -input high_res.pdf -width 3840 -height 2160 -quality 90 -dpi 600
```
Использует высокий битрейт и DPI для кристально четкого изображения.

### Генерация сценария Smart Zoom
```bash
./pdf2video -input presentation.pdf -generate-scenario
```
Анализирует слайды, находит ключевые блоки и создает YAML сценарий в `internal/scenarios/scenario_2026-02-13_01-42-26.yaml`.

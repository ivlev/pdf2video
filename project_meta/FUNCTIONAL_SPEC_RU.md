# Функциональная спецификация pdf2video

**Версия:** 0.9.0 (Modular Encoding & Graceful Shutdown)
**Дата:** 2026-02-18

## 1. Обзор продукта
`pdf2video` — это высокопроизводительная утилита командной строки (CLI) для автоматического создания динамичных видео-презентаций из статических PDF-файлов или наборов изображений. Программа превращает статичные слайды в кинематографичный видеоряд с точным управлением камерой через YAML-сценарии, синхронизацией с аудио и аппаратным ускорением.

## 2. Основные возможности

### 2.1. Входные данные
- **PDF Документы:** Рендеринг страниц в высоком разрешении (настраиваемый DPI).
- **Изображения:** Папки с файлами `.jpg`, `.jpeg`, `.png`. Поддерживается сортировка и фильтрация.
- **Аудио:** Автоматический подбор саундтрека из папки `input/audio` или указание конкретного файла.
- **Сценарии (YAML):** Описание ключевых кадров (keyframes) для управления зумом и панорамированием.

### 2.2. Генерация видео
- **Пресеты:** YouTube (16:9), TikTok/Shorts (9:16), Instagram (4:5).
- **Scenario Rendering:** Точное движение камеры по заданным координатам и времени.
- **Smart Zoom (Auto-Plan):** Автоматическая генерация сценариев на основе анализа содержимого слайдов.
- **Переходы:** Поддержка всех эффектов `xfade` (fade, wipe, slide, pixelize и др.).
- **Синхронизация:** Длительность видео в точности соответствует аудио-треку.
- **Outro Zoom-out:** Гарантированный возврат камеры к исходному масштабу 1:1 перед каждым переходом.
- **Двухслойный звук:** Наложение фоновой музыки (`input/background`) на основной трек с автоматическим зацикливанием и фейдами.
- **Graceful Shutdown:** Корректная остановка всех процессов FFmpeg и удаление временных файлов при нажатии Ctrl+C.
- **Модульная Архитектура:** Выделение логики кодирования в отдельный пакет `video` для упрощения поддержки новых форматов.
- **Frame-Boundary Alignment:** Все расчеты времени выравниваются по границам кадров (FPS) для исключения джиттера и проблем со склейкой.

## 3. Архитектура и Оптимизации

### 3.1. Аппаратное ускорение
Приложение автоматически выбирает лучший доступный энкодер:
- **macOS:** `h264_videotoolbox` (Apple Silicon / Intel).
- **NVIDIA:** `h264_nvenc`.
- **CPU:** `libx264` (Fallback).

### 3.2. Pipelining & Memory Pipes
- **Render Pool (CPU):** Параллельный рендеринг страниц.
- **Encode Pool (GPU):** Кодирование сегментов видео.
- **Zero-Disk I/O:** Изображения передаются напрямую в FFmpeg через `stdin pipe` в формате `rawvideo`.
- **PDF Document Pooling:** Использование `sync.Pool` для переиспользования открытых PDF-документов, что устраняет избыточные I/O операции при параллельном рендеринге.
- **Buffer Pooling:** Центрлизованный пул для повторного использования `image.RGBA` буферов. Снижает нагрузку на Garbage Collector и предотвращает фрагментацию памяти.
- **Adaptive DPI:** Автоматический расчет минимально необходимой плотности пикселей (DPI) под целевое разрешение видео с 50% запасом под зум. Снижает нагрузку на CPU на 20-40%.

### 3.3. Smart Zoom & Scenario Rendering
- **Analyze:** Детекция регионов интереса (заголовки, текст) через `ContrastDetector`.
- **Plan:** Генерация YAML сценария с ключевыми кадрами.
- **Scale:** Автоматическое масштабирование таймингов сценария под длительность аудиофайла.
- **Render:** Применение `ScenarioEffect` для генерации сложных piecewise-выражений `zoompan`.

## 4. Справочник конфигурации (Флаги)

### Основные
| Флаг | Описание | По умолчанию |
|------|----------|--------------|
| `-input` | Путь к PDF или папке с изображениями | Свежий файл в `input/pdf/` |
| `-output` | Путь к выходному файлу | Авто-генерация в `output/` |
| `-preset` | Пресет формата (`16:9`, `9:16`, `4:5`) | - |

### Видео и Аудио
| Флаг | Описание | По умолчанию |
|------|----------|--------------|
| `-width`, `-height` | Явное указание разрешения | 1280x720 |
| `-fps` | Частота кадров | 30 |
| `-duration` | Общая длительность видео (сек) | 0 (авто по аудио) |
| `-page-duration` | Средняя длительность слайда (сек) | 0.3 |
| `-audio` | Путь к аудио-файлу | Свежий файл в `input/audio/` |
| `-audio-sync` | Синхронизировать видео под длину аудио | `true` |

### Эффекты
| Флаг | Описание | По умолчанию |
|------|----------|--------------|
| `-zoom-mode` | Тип зума (`center`, `random` и др.) | `center` |
| `-zoom-speed` | Скорость зума | `0.001` |
| `-transition` | Тип перехода (`fade`, `wipeleft`...) | `fade` |
| `-fade` | Длительность эффекта перехода (сек) | `0.5` |
| `-outro-duration` | Время возврата в 1:1 перед переходом | `1.0` |
| `-bg-audio` | Путь к фоновому треку | авто |
| `-bg-volume` | Громкость фонового трека (0.0 - 1.0) | `0.3` |

### Качество и Производительность
| Флаг | Описание | По умолчанию |
|------|----------|--------------|
| `-dpi` | Качество рендеринга PDF | 300 |
| `-quality` | Качество (CRF для x264, Битрейт для GPU) | `авто` (x264: 23, VT: 75) |
| `-stats` | Вывод метрик производительности | `false` |
| `-debug` | Режим отладки: отрисовка траектории камеры и статистики | `false` |
| `-workers` | Количество потоков рендеринга | Все ядра CPU |

### Smart Zoom (Анализ и Сценарии)
| Флаг | Описание | По умолчанию |
|------|----------|--------------|
| `-analyze-mode` | Режим анализа (`contrast`, `ocr`, `ai`) | `contrast` |
| `-min-block-area` | Минимальная площадь блока (пиксели²) | 500 |
| `-edge-threshold` | Порог чувствительности границ | 30.0 |
| `-generate-scenario` | Генерировать YAML сценарий | `false` |
| `-scenario-output` | Путь для сохранения сценария | `internal/scenarios/scenario_YYYY-MM-DD_HH-MM-SS.yaml` |
| `-scenario` | Путь к сценарию для рендеринга | Самый свежий из `internal/scenarios/` |

## 5. Техническое превосходство и Надежность

### 5.1. Масштабируемость сценариев
- **$O(N)$ Expression Optimization:** Сложные фильтры панорамирования оптимизированы математически, что позволяет запускать сценарии с сотнями ключевых кадров без деградации производительности и ошибок переполнения FFmpeg.
- **Filter Scripts:** Использование `-filter_script` позволяет обходить системные ограничения ОС на длину командной строки, обеспечивая стабильность на проектах любой длительности.

### 5.2. Визуальная отладка
- **Debug Overlay:** Встроенный визуализатор позволяет видеть границы интереса (Bounding Boxes) непосредственно в сгенерированном видео для упрощения настройки сценариев.
- **Go-side Drawing:** Критически важные элементы отладки (траектория камеры) рисуются на стороне движка Go, что гарантирует их отображение даже при сбоях фильтров FFmpeg.

## 5. Сценарии использования

### Быстрый тест
```bash
./pdf2video -stats
```
Берет первый попавшийся PDF и аудио, создает видео, выводит статистику.

### Создание Shorts для TikTok
```bash
./pdf2video -input presentation.pdf -preset 9:16 -duration 60 -zoom-mode random
```
Создает вертикальное видео ровно на 60 секунд со случайными движениями камеры.

### Максимальное качество (4K)
```bash
./pdf2video -input high_res.pdf -width 3840 -height 2160 -quality 90 -dpi 600
```
Использует высокий битрейт и DPI для кристально четкого изображения.

### Генерация сценария Smart Zoom
```bash
./pdf2video -input presentation.pdf -generate-scenario
```
Анализирует слайды, находит ключевые блоки и создает YAML сценарий в `internal/scenarios/scenario_2026-02-13_01-42-26.yaml`.
